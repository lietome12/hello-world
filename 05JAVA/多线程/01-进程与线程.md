# 1.进程产生的背景

最初计算机只能接受一些特定的指令，用户输入一个指令，计算机就做出一个操作。当用户在思考或输入时，计算机就在等待。很多时候计算机都处于等待状态，这样效率十分低下。

#### 批处理操作系统

后来有了批处理操作系统，把一系列需要操作的指令写下来，形成一个清单，一次性交给计算机处理。用户将多个需要执行的程序写在磁带上，然后交给计算机去读取并逐行执行，并将输出结果写到另一个磁带上。

批处理操作系统在一定意义上提高了计算机的执行效率，但是由于批处理操作系统的指令运行方式仍然是串行的，内存中始终只有一个程序在运行，后边的程序需要等待前面的程序运行完成后才能开始执行。而前面的程序有时会由于I/O操作、网络等原因阻塞，所以批处理效率也不高。

串行：从上往下顺序执行。

#### 进程的提出

待解决的问题：内存中只存在一个程序。比如我打开QQ音乐就不能再开启其它应用，需要先关闭QQ音乐?

进程就是**应用程序在内存中分配的空间，也是正在运行的程序**。进程间互不干扰，同时进程保存着程序每一时刻的运行状态。

程序：用某种编程语言编写，能够完成一定任务或功能的代码合集。是指令和数据的有效结合，是一段静态代码。

注：我们写的程序都会jvm被编译成指令，而程序就是对数据进行操作

CPU采用**时间片轮转**的方式运行进程。CPU为每个进程分配一个时间段，称为它的时间片。如果在这个时间片结束时进程还在运行，就暂停这个进程，并且CPU分配给另外一个进程(这个过程叫做上下文切换)。如果进程在时间片内结束前阻塞或结束，CPU会立即进行切换，不用等待时间片用完。

当进程暂停时，它会保存当前进程的状态(进程标识，进程使用的资源等)，在下一次切换回来时根据之前保存的状态进行恢复，然后接着继续执行。

注：CPU进行上下文切换时，如何选择执行某一程序呢? 是用户点哪个切换哪个? 我记得是抢占CPU执行权啊。

虽然并发从宏观上看有多个任务在执行，但事实上，对于**单核CPU**来说，任意具体时刻都只有一个任务在占用CPU资源。

注：我在使用word时，还在听QQ音乐，这个是两个不同的进程，进程切换太快? 听音乐同时，将部分音乐下载到本地，是同进程内多线程?

一个进程在一段时间只能做一件事，如果一个进程有多个子任务时，只能逐个执行这些子任务，很影响效率。

线程，让一个线程执行一个子任务，这样一个进程就包含了多个线程，每个线程负责一个单独的子任务。操作系统是如何分配时间片给一个线程，涉及到线程的调度策略。

进程让操作系统的并发性成为了可能，而线程让进程的内部并发成为了可能。

多进程的方式也可以实现并发，为什么要使用多线程呢?

**使用多线程的好处：**

- 进程间的通信比较复杂，而线程间的通信比较简单，通常情况下，我们需要使用共享资源，这些资源在线程间的通信比较容易。
- 进程是重量级的，而线程是轻量级的，所以多线程方式的系统开销更小。

**进程和线程的区别：**

进程是一个独立的运行环境，而线程是在进程中执行的一个任务。他们两个的本质区别是：**是否单独占有内存地址空间及其它系统资源(如I/O)**：

- 进程单独占有一定的内存地址空间，所以进程间存在内存隔离，数据是分开的。**数据共享**复杂但是**同步**简单，各进程间互不干扰；而线程共享所属进程占有的内存地址空间和资源，数据共享简单，但同步复杂。
- 进程单独占有一定的内存地址空间，一个进程出现问题不会影响其他进程，不影响主程序的**稳定性**，可靠性高。一个线程的崩溃可能会影响整个程序的稳定性，可靠性较低。
- 进程单独占有一定的内存地址空间，进程的**创建和销毁**不仅需要保存寄存器和栈信息，还需要资源的分配回收以及页调度，开销较大；线程只需要保存寄存器和栈信息，开销较小。

另外一个重要区别：**进程是操作系统进行****资源分配****的基本单位，而线程是操作系统进行调度的基本单位**，即CPU分配时间的单位。

#### 上下文切换

有时也叫做进程切换或任务切换。指的是CPU从一个进程(或线程)切换到另外一个进程(或线程)。**上下文是指某一时间点CPU寄存器和程序计数器的内容**。

注：那上下文切换指的就是改变CPU寄存器和程序计数器的内容? 寄存器保存什么? 程序计数器是否和jvm中的程序计数器相同?

寄存器是cpu内部中**少量的速度很快的闪存**，**通常存储和访问计算过程中的中间值**，提高计算机程序的运行速度。

程序计数器是**一个专用的寄存器**，用于表明**指令序列中CPU正在执行的位置**。存的值为正在执行的指令位置或下一个将要被执行的指令位置。具体实现依赖于特定的系统。

举例： 线程A - B

1.先挂起线程A，将其在cpu中的状态(执行状态)保存在内存中

2.在内存中检索下一个线程B的上下文并将其在CPU的寄存器中恢复，执行B线程

3.当B执行完，根据程序计数器中指向的位置恢复线程A

注：还是不太理解这个过程，不清楚CPU内部结构和每个结构的功能，他们之间又如何协调工作的。

**指令寄存器**存当前指令，**程序计数器**用来存下条指令的地址。CPU通过程序计数器中存储的地址取指令，将取到的指令送到指令寄存器中。**CPU的寄存器和程序计数器就是CPU上下文**。因为它们都是CPU在运行任何任务前，必须要依赖的环境。

CPU上下文切换：将前一个任务的CPU上下文(也就是寄存器和程序计数器)保存起来，然后加载新任务的上下文到寄存器和程序计数器，最后跳转到程序计数器所指的新位置，执行新任务。保存的上下文存储在系统内核中，并在任务重新调度执行时再次加载进来。这样能保证原来的任务不受影响，看起来还是连续运行的。

CPU通过为每个线程分配时间片来实现多线程机制。CPU通过时间片分配算法来循环执行任务，当前任务执行一个时间片后会切换到下一个任务。

但是，在切换前会保存上一个任务的状态，以便下次切换回这个任务时，可以再加载这个任务的状态。所以任务从保存到加载的过程中就是一次上下文切换。

**上下文切换会消耗大量的CPU时间，所以线程也不是越多越好**。如何减少系统中的上下文切换次数，是提升多线程性能的一个重要课题。